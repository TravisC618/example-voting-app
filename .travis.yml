sudo: required

env:
  - DOCKER_COMPOSE_VERSION=1.29.2

services:
  - docker

### update docker compose version
before_install:
  - sudo rm /usr/local/bin/docker-compose
  - curl -L https://github.com/docker/compose/releases/download/${DOCKER_COMPOSE_VERSION}/docker-compose-`uname -s`-`uname -m` > docker-compose
  - chmod +x docker-compose
  - sudo mv docker-compose /usr/local/bin

jobs:
  include:
    - stage: integration tests
      script: 
        - "echo '================ Integration Test started ================'"
        - docker-compose -f result/docker-compose.test.yml run sut

### if tests are all passed, push image before deploying
### require the branch name to be master
after_success:
  - test $TRAVIS_BRANCH = "master" && 
    docker login -u $DOCKER_USERNAME -p $DOCKER_PWD &&
    docker-compose build --pull &&
    docker-compose push &&
    docker logout
  
deploy:
  provider: elasticbeanstalk
  region: "us-east-1"
  app: "voting-app"
  env: "Votingapp-env"
  bucket: "elasticbeanstalk-us-east-1-615572604844"
  bucket_path: "VotingApp"
  on:
      repo: TravisC618/example-voting-app
      branch: master
  access_key_id: "$AWS_ACCESS_KEY"
  secret_access_key: "$AWS_SECRET_KEY"
